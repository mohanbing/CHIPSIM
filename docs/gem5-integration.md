# GEM5/Garnet Integration

The simulator integrates gem5's Garnet network simulator for cycle-accurate Network-on-Interposer (NoI) modeling.

## Installation

### Build gem5 for Network Simulation

Navigate to the integrations/gem5 directory:

```bash
cd integrations/gem5
```

Build Garnet standalone:

```bash
python3 `which scons` build/Garnet_standalone/gem5.opt -j12
```

**Build options:**
- `-j12`: Use 12 parallel jobs (adjust based on your CPU cores)
- `gem5.opt`: Optimized build (faster simulation)
- `gem5.debug`: Debug build (slower, more verbose)

**Build requirements:**
- Python 3.6+
- SCons build system
- C++ compiler (gcc 7+ or clang 6+)
- Development libraries (see gem5 documentation)

### Verify Installation

Test that gem5 built successfully:

```bash
./build/Garnet_standalone/gem5.opt --version
```

## Standalone Garnet Testing

Test Garnet with synthetic traffic before running full simulations.

### Basic Synthetic Traffic

```bash
./build/Garnet_standalone/gem5.opt configs/example/garnet_synth_traffic.py \
    --num-cpus=16 \
    --num-dirs=16 \
    --network=garnet \
    --topology=Mesh_XY \
    --mesh-rows=4 \
    --synthetic=uniform_random \
    --injectionrate=0.1 \
    --sim-cycles=50000
```

**Parameters:**
- `--num-cpus`: Number of compute nodes (chiplets)
- `--num-dirs`: Number of directory nodes (typically equals num-cpus)
- `--topology`: Network topology (Mesh_XY, Torus, etc.)
- `--mesh-rows`: For mesh topologies, rows in 2D grid
- `--synthetic`: Traffic pattern (uniform_random, bit_complement, tornado, etc.)
- `--injectionrate`: Packets injected per node per cycle (0.0-1.0)
- `--sim-cycles`: Number of cycles to simulate

### Trace-Based Simulation

Run Garnet with real workload traces:

```bash
./build/Garnet_standalone/gem5.opt configs/example/garnet_synth_traffic.py \
    --num-cpus=100 \
    --num-dirs=100 \
    --topology=Mesh_XY \
    --mesh-rows=10 \
    --sim-cycles=50000 \
    --injectionrate=0 \
    --network-trace-enable \
    --network-trace-file="debug.log.gz" \
    --network-trace-max-packets=1
```

**Trace parameters:**
- `--injectionrate=0`: Disable synthetic traffic (use trace only)
- `--network-trace-enable`: Enable trace-based injection
- `--network-trace-file`: Path to trace file (generated by simulator)
- `--network-trace-max-packets`: Packets per trace entry (usually 1)


## DSENT Power/Area Analysis

Estimate NoI power consumption using DSENT.

### Prerequisites

Ensure gem5 is built with DSENT support:

```bash
cd integrations/gem5
python3 `which scons` build/Garnet_standalone/gem5.opt --with-dsent -j12
```

### Run Power Analysis

After a Garnet simulation completes:

```bash
python util/on-chip-network-power-area.py . m5out \
    gem5/ext/dsent/configs/garnet_router.cfg \
    gem5/ext/dsent/configs/garnet_link.cfg \
    32 500
```

**Arguments:**
1. `.`: gem5 root directory
2. `m5out`: Output directory from simulation
3. Router config file path
4. Link config file path
5. `32`: Technology node (nm)
6. `500`: Frequency (MHz)

**Output:**
- Per-router dynamic and static power
- Per-link dynamic and static power
- Router area
- Total network power and area

### DSENT Configuration Files

DSENT configs define router and link models:

**Router config** (`garnet_router.cfg`):
- Router pipeline stages
- Buffer sizes
- Crossbar configuration
- Technology parameters

**Link config** (`garnet_link.cfg`):
- Wire model
- Repeater insertion
- RC parameters

Modify these files to match your NoI design.

## Simulator Integration

### How the Simulator Uses gem5

1. **Traffic Generation:**
   - Simulator analyzes DNN workload
   - Generates communication traces (source, dest, size, time)
   - Writes trace file for gem5

2. **Garnet Execution:**
   - Simulator invokes gem5 with trace file
   - Garnet simulates NoI traffic
   - Returns cycle-accurate timing results

3. **Result Integration:**
   - Simulator reads gem5 statistics
   - Updates layer completion times
   - Computes end-to-end metrics

### Configuration in Simulation Config

```yaml
comm_simulator: "Garnet"  # Use gem5 Garnet (vs. Booksim)
enable_dsent: false        # Enable power analysis
gem5_sim_cycles: 500000000 # Max simulation cycles
gem5_ticks_per_cycle: 1000 # Time resolution
dsent_tech_node: "32"      # For power analysis
```

### gem5 Output Files

gem5 creates several output files in the simulation results directory:

- `stats.txt`: Detailed network statistics
- `config.ini`: Network configuration used
- `network.txt`: Network topology and routing
- `power.txt`: Power estimates (if DSENT enabled)

## Troubleshooting

### Build Errors

**Issue:** "Could not find scons"
```bash
pip install scons
```

**Issue:** Missing dependencies
```bash
# Ubuntu/Debian
sudo apt-get install build-essential scons python3-dev zlib1g-dev

# See gem5 documentation for other platforms
```
## Advanced Usage

### Custom Topologies

Custom topologies can be integrated into Garnet, as performed for the hardware validation. Documentation TBD. 


## Related Documentation

- [Advanced Features](advanced-features.md) - DSENT, caching, performance tuning
- [Configuration Reference](../README.md#configuration) - Network parameters
- [Components](components.md) - Communication simulator architecture
- [gem5 Documentation](http://www.gem5.org/) - Official gem5 resources
